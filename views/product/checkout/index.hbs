<div class="container mt-5">
    <h1 class="mb-4">Checkout</h1>

    <div class="row">
        <!-- Phần thông tin cá nhân (1 nửa) -->
        {{#each data}}
        {{#if @first}}
        <div class="col-md-6">
            <form id="checkoutForm">
                <div class="form-group">
                    <label for="address">Địa chỉ:</label>
                    <input type="text" class="form-control" id="address"
                        name="address" value="{{address}}">
                </div>

                <div class="form-group">
                    <label for="phone">Số điện thoại</label>
                    <input type="tel" class="form-control" id="phone"
                        name="phone" value="{{phone}}">
                </div>

                <div class="form-group">
                    <label for="email">Email</label>
                    <input type="email" class="form-control" id="email"
                        name="email" value="{{email}}">
                </div>
            </form>
        </div>
        {{/if}}
        {{/each}}

        <!-- Phần sản phẩm trong giỏ hàng (1 nửa) -->
        <div class="table-wrapper-responsive">
            <table summary="Shopping cart">
                {{#each data}}
                <tr>
                    <!-- Các cột thông tin sản phẩm -->
                    <td class="goods-page-image">
                        <a href="javascript:;"><img src={{urls}}
                                alt="Berry Lace Dress"></a>
                    </td>
                    <td class="goods-page-description">
                        <h3><a
                                href="/product/product-detail/{{id}}">{{name}}</a></h3>
                        <p><strong>Item {{id}}</strong> - Color:
                            Green; Size: S</p>
                        <em>{{description}}</em>
                    </td>
                    <td class="goods-page-ref-no">
                        {{id}}
                    </td>
                    <td class="goods-page-quantity">
                        <div class="product-quantity">
                            <input type="number" value="1"
                                class="form-control input-sm"
                                onchange="updateTotalPrice(this)">
                        </div>
                    </td>
                    <td class="goods-page-total">
                        <strong class="total-price">${{price}}</strong>
                    </td>
                    <td class="del-goods-col">
                        <a class="del-goods" href="javascript:;">&nbsp;</a>
                    </td>
                </tr>
                {{/each}}
                <!-- Mã JavaScript nhúng vào trong file .hbs -->
            </table>
        </div>
    </div>

    <div class="form-group text-center">
        <button type="button" class="btn btn-primary"
            onclick="submitOrder({{json data}})">Đặt hàng</button>
    </div>
</div>

<script>
    function submitOrder(data) {
        // Lấy thông tin từ form và sản phẩm
        const formData = new FormData(document.getElementById('checkoutForm'));
        console.log(formData)
        //const products = Object.values(data);

// Thêm thông tin sản phẩm vào formData
products.forEach(product => {
    formData.append('products[]', JSON.stringify(product));
});

    // Gửi yêu cầu POST đến API checkout
    fetch('/auth/api/checkout', {
        method: 'POST',
        body: formData
    })
        .then(response => response.json())
        .then(data => {
            // Xử lý kết quả từ API nếu cần
            console.log(data);
        })
        .catch(error => {
            console.error('Error:', error);
        });
    };

</script>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        // Cập nhật tổng giá trị của tất cả sản phẩm và phí vận chuyển khi trang được load
        updateGrandTotal();

        // Gắn sự kiện cho các input số lượng để cập nhật tổng giá trị khi người dùng thay đổi số lượng
        var quantityInputs = document.querySelectorAll('.quantity-input');
        quantityInputs.forEach(function (input) {
            input.addEventListener('input', function () {
                updateTotalPrice(input);
            });
        });
    });
    // Hàm cập nhật tổng giá trị cho sản phẩm cụ thể
    function updateTotalPrice(input) {
        // Lấy các phần tử DOM liên quan đến sản phẩm cụ thể
        var row = input.closest('tr');
        var unitPriceElement = row.querySelector('.unit-price');
        var totalPriceElement = row.querySelector('.total-price');

        // Lấy giá trị số lượng mới từ input
        var quantity = input.value;

        // Lấy giá trị đơn giá từ DOM
        var unitPrice = parseFloat(unitPriceElement.innerText.replace("$", ""));

        // Tính tổng giá trị mới
        var totalPrice = unitPrice * quantity;

        // Cập nhật tổng giá trị của sản phẩm vào DOM
        totalPriceElement.innerText = "$" + totalPrice.toFixed(0);

        // Cập nhật tổng giá trị của tất cả sản phẩm và phí vận chuyển
        updateGrandTotal();
    }

    // Hàm cập nhật tổng giá trị của tất cả sản phẩm và phí vận chuyển
    function updateGrandTotal() {
        // Lấy tất cả các phần tử total-price trong bảng
        var totalElements = document.querySelectorAll('.total-price');

        // Tính tổng giá trị của tất cả sản phẩm
        var grandTotal = Array.from(totalElements).reduce(function (sum, element) {
            var price = parseFloat(element.innerText.replace("$", ""));
            return sum + price;
        }, 0);

        // Phí vận chuyển mặc định
        var shippingFee = 5.00;

        // Tổng giá trị kết hợp phí vận chuyển
        var totalWithShipping = grandTotal + shippingFee;

        // Hiển thị tổng giá trị và phí vận chuyển mới trong phần tử có class là "shopping-total"
        document.querySelector('.shopping-total li.em-subtotal strong.price').innerText = "$" + grandTotal.toFixed(0);
        document.querySelector('.shopping-total li.em-shipping strong.price').innerText = "$" + shippingFee.toFixed(0);
        document.querySelector('.shopping-total li.shopping-total-price strong.price').innerText = "$" + totalWithShipping.toFixed(0);
    }
</script>